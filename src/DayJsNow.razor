@namespace Soenneker.Blazor.Dayjs
@using System
@using System.Globalization
@using System.Threading
@using System.Threading.Tasks
@using Soenneker.Blazor.Dayjs.Utils
@using Soenneker.Quark

@inherits CoreCancellableComponent

@if (_value is not null)
{
    @(_value)
}

@code {
    [Parameter] public string Format { get; set; } = "HH:mm:ss";
    [Parameter] public string? Timezone { get; set; }
    [Parameter] public string? UpdateInterval { get; set; } = "1s";
    [Parameter] public bool AutomaticUpdate { get; set; } = true;

    private string? _value;
    private DayJsSubscriptionKey _subscriptionKey;
    private bool _hasSubscriptionKey;

    protected override async Task OnParametersSetAsync()
    {
        var key = new DayJsSubscriptionKey(0, Format, UpdateInterval, Timezone, false, false, AutomaticUpdate);

        if (_hasSubscriptionKey && _subscriptionKey.Equals(key))
            return;

        _subscriptionKey = key;
        _hasSubscriptionKey = true;
        await Resubscribe();
    }

    private async Task Resubscribe()
    {
        await ResetCancellation();

        if (!AutomaticUpdate)
        {
            _value = FormatNow();
            _ = InvokeAsync(StateHasChanged);
            return;
        }

        var interval = DayJsIntervalParser.ParseOrDefault(UpdateInterval, TimeSpan.FromSeconds(1));
        _value = FormatNow();
        _ = InvokeAsync(StateHasChanged);
        _ = RunLoop(interval, CancellationToken);
    }

    private async Task RunLoop(TimeSpan interval, CancellationToken token)
    {
        try
        {
            using var timer = new PeriodicTimer(interval);

            while (await timer.WaitForNextTickAsync(token))
            {
                _value = FormatNow();
                _ = InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
        }
    }

    private string FormatNow()
    {
        var now = GetNow();
        return now.ToString(Format, CultureInfo.InvariantCulture);
    }

    private DateTimeOffset GetNow()
    {
        if (string.IsNullOrWhiteSpace(Timezone))
            return DateTimeOffset.Now;

        if (TryResolveTimeZone(Timezone, out TimeZoneInfo? zone))
            return TimeZoneInfo.ConvertTime(DateTimeOffset.UtcNow, zone);

        return DateTimeOffset.Now;
    }

    private static bool TryResolveTimeZone(string timezone, out TimeZoneInfo? zone)
    {
        try
        {
            zone = TimeZoneInfo.FindSystemTimeZoneById(timezone);
            return true;
        }
        catch (TimeZoneNotFoundException)
        {
            zone = null;
            return false;
        }
        catch (InvalidTimeZoneException)
        {
            zone = null;
            return false;
        }
    }

    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync();
    }
}
