@namespace Soenneker.Blazor.Dayjs
@using System
@using Soenneker.Blazor.Dayjs.Abstract
@using Soenneker.Blazor.Dayjs.Dtos
@using Soenneker.Blazor.Dayjs.Utils
@using Soenneker.Quark
@inject IDayJsInterop DayJsInterop

@inherits CoreCancellableComponent

@if (_value is not null)
{
    @(_value)
}

@code {
    [Parameter] public DateTimeOffset Value { get; set; }
    [Parameter] public string? UpdateInterval { get; set; } = "1m";
    [Parameter] public bool WithoutSuffix { get; set; }
    [Parameter] public string? Timezone { get; set; }
    [Parameter] public bool AutomaticUpdate { get; set; } = true;

    private string? _value;
    private DayJsSubscription? _subscription;
    private DayJsSubscriptionKey _subscriptionKey;
    private bool _hasSubscriptionKey;

    protected override async Task OnParametersSetAsync()
    {
        var key = new DayJsSubscriptionKey(Value.ToUnixTimeMilliseconds(), string.Empty, UpdateInterval, Timezone, WithoutSuffix, false, AutomaticUpdate);

        if (_hasSubscriptionKey && _subscription is not null && _subscriptionKey.Equals(key))
            return;

        _subscriptionKey = key;
        _hasSubscriptionKey = true;
        await Resubscribe();
    }

    private async Task Resubscribe()
    {
        var token = CancellationToken;

        if (_subscription is not null)
            await _subscription.DisposeAsync();

        if (!AutomaticUpdate)
        {
            _subscription = null;
            _value = await DayJsInterop.FromNow(Value, WithoutSuffix, Timezone, token);
            _ = InvokeAsync(StateHasChanged);
            return;
        }

        var interval = DayJsIntervalParser.ParseOrDefault(UpdateInterval, TimeSpan.FromMinutes(1));

        _subscription = await DayJsInterop.SubscribeRelative(
            Value,
            interval,
            value =>
            {
                _value = value;
                _ = InvokeAsync(StateHasChanged);
            },
            WithoutSuffix,
            Timezone,
            token);
    }

    public override async ValueTask DisposeAsync()
    {
        if (_subscription is not null)
            await _subscription.DisposeAsync();

        await base.DisposeAsync();
    }


}
